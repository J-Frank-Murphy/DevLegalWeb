{% extends "admin/base_layout.html" %}

{% block title %}{% if post %}Edit Post{% else %}New Post{% endif %} - Dev Legal{% endblock %}

{% block header_title %}{% if post %}Edit Post{% else %}New Post{% endif %}{% endblock %}

{% block content %}
<div class="admin-content">
    <form method="POST" enctype="multipart/form-data" class="post-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token( ) }}"/>
        
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="{{ post.title if post else '' }}" required>
        </div>
        
        <div class="form-group">
            <label for="slug">Slug</label>
            <input type="text" id="slug" name="slug" value="{{ post.slug if post else '' }}">
            <small>Leave empty to auto-generate from title</small>
        </div>
        
        <div class="form-group">
            <label for="excerpt">Excerpt</label>
            <textarea id="excerpt" name="excerpt" rows="3">{{ post.excerpt if post else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="content">Content</label>
            <!-- Replace textarea with Quill container and hidden input -->
            <div id="editor-container" style="height: 400px;"></div>
            <input type="hidden" id="content" name="content" value="{{ post.content if post else '' }}">
            <small>Use the rich text editor to format content, add images, tables, and more</small>
        </div>
        
        <div class="form-group">
            <label for="category_id">Category</label>
            <select id="category_id" name="category_id" required>
                <option value="">Select Category</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if post and post.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Tags</label>
            <div class="tag-checkboxes">
                {% for tag in tags %}
                <div class="tag-checkbox">
                    <input type="checkbox" id="tag-{{ tag.id }}" name="tags" value="{{ tag.id }}" {% if post and tag in post.tags %}checked{% endif %}>
                    <label for="tag-{{ tag.id }}">{{ tag.name }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="form-group">
            <label for="featured_image_url">Featured Image URL</label>
            <input type="text" id="featured_image_url" name="featured_image_url" value="{{ post.featured_image if post else '' }}">
            <small>Enter a URL or upload an image below</small>
        </div>
        
        <div class="form-group">
            <label for="featured_image_file">Upload Featured Image</label>
            <input type="file" id="featured_image_file" name="featured_image_file" accept="image/*">
            <small>Supported formats: JPG, PNG, GIF, WebP</small>
            {% if post and post.featured_image %}
            <div class="current-image">
                <p>Current image:</p>
                <img src="{{ url_for('static', filename=post.featured_image) }}" alt="Featured image" style="max-width: 200px; max-height: 200px;">
            </div>
            {% endif %}
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="published" name="published" {% if post and post.published %}checked{% endif %}>
            <label for="published">Published</label>
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="comments_enabled" name="comments_enabled" {% if not post or post.comments_enabled %}checked{% endif %}>
            <label for="comments_enabled">Enable Comments</label>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{% if post %}Update{% else %}Create{% endif %} Post</button>
            <a href="{{ url_for('admin.posts') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Add CSS for the editor -->
<style>
    /* Custom styles for the Quill editor */
    .ql-editor {
        min-height: 300px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
    }
    
    .ql-toolbar {
        background-color: #f8f9fa;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        border: 1px solid #ddd;
    }
    
    .ql-container {
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        border: 1px solid #ddd;
        border-top: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Style for image captions */
    .image-caption {
        font-style: italic;
        color: #666;
        text-align: center;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Quill editor with full toolbar
        var quill = new Quill('#editor-container', {
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    ['blockquote', 'code-block'],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            },
            placeholder: 'Compose your content...',
            theme: 'snow'
        });
        
        // Set initial content if editing an existing post
        const contentInput = document.getElementById('content');
        if (contentInput.value) {
            quill.root.innerHTML = contentInput.value;
        }
        
        // Custom image handler
        var toolbar = quill.getModule('toolbar');
        toolbar.addHandler('image', function() {
            var fileInput = document.createElement('input');
            fileInput.setAttribute('type', 'file');
            fileInput.setAttribute('accept', 'image/*');
            fileInput.click();
            
            fileInput.onchange = function() {
                var file = fileInput.files[0];
                if (file) {
                    var formData = new FormData();
                    formData.append('file', file);
                    
                    // Get CSRF token
                    var token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    formData.append('csrf_token', token);
                    
                    // Upload the image
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/admin/upload-image', true);
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            if (response.url) {
                                // Insert the image into the editor
                                var range = quill.getSelection();
                                quill.insertEmbed(range.index, 'image', response.url);
                            }
                        } else {
                            console.error('Upload failed');
                        }
                    };
                    xhr.send(formData);
                }
            };
        });
        
        // Update hidden input before form submission
        document.querySelector('.post-form').addEventListener('submit', function() {
            document.getElementById('content').value = quill.root.innerHTML;
        });
        
        // Auto-generate slug from title
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');
        
        if (titleInput && slugInput) {
            titleInput.addEventListener('blur', function() {
                if (slugInput.value === '' && titleInput.value !== '') {
                    // Simple slug generation
                    slugInput.value = titleInput.value
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim();
                }
            });
        }
    });
</script>
{% endblock %}
