{% extends "admin/base_layout.html" %}

{% block title %}{% if post %}Edit Post{% else %}New Post{% endif %} - Dev Legal{% endblock %}

{% block header_title %}{% if post %}Edit Post{% else %}New Post{% endif %}{% endblock %}

{% block content %}
<div class="admin-content">
    <form method="POST" enctype="multipart/form-data" class="post-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="{{ post.title if post else '' }}" required>
        </div>
        
        <div class="form-group">
            <label for="slug">Slug</label>
            <input type="text" id="slug" name="slug" value="{{ post.slug if post else '' }}">
            <small>Leave empty to auto-generate from title</small>
        </div>
        
        <div class="form-group">
            <label for="excerpt">Excerpt</label>
            <textarea id="excerpt" name="excerpt" rows="3">{{ post.excerpt if post else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="content">Content</label>
            <textarea id="content" name="content" rows="15">{{ post.content if post else '' }}</textarea>
            <small>HTML markup is allowed</small>
        </div>
        
        <!-- Content Image Upload Section -->
        <div class="form-group">
            <label>Content Images</label>
            <div class="content-image-upload">
                <div class="upload-area" id="content-image-dropzone">
                    <p>Drag & drop images here or click to upload</p>
                    <input type="file" id="content-image-input" accept="image/*" style="display: none;">
                </div>
                <div class="upload-preview" id="content-image-preview">
                    <!-- Uploaded images will appear here -->
                </div>
                <small>Upload images to insert into your content. Supported formats: JPG, PNG, GIF, WebP</small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="category_id">Category</label>
            <select id="category_id" name="category_id" required>
                <option value="">Select Category</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if post and post.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Tags</label>
            <div class="tag-checkboxes">
                {% for tag in tags %}
                <div class="tag-checkbox">
                    <input type="checkbox" id="tag-{{ tag.id }}" name="tags" value="{{ tag.id }}" {% if post and tag in post.tags %}checked{% endif %}>
                    <label for="tag-{{ tag.id }}">{{ tag.name }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="form-group">
            <label for="featured_image_url">Featured Image URL</label>
            <input type="text" id="featured_image_url" name="featured_image_url" value="{{ post.featured_image if post else '' }}">
            <small>Enter a URL or upload an image below</small>
        </div>
        
        <div class="form-group">
            <label for="featured_image_file">Upload Featured Image</label>
            <input type="file" id="featured_image_file" name="featured_image_file" accept="image/*">
            <small>Supported formats: JPG, PNG, GIF, WebP</small>
            {% if post and post.featured_image %}
            <div class="current-image">
                <p>Current image:</p>
                <img src="{{ url_for('static', filename=post.featured_image) }}" alt="Featured image" style="max-width: 200px; max-height: 200px;">
            </div>
            {% endif %}
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="published" name="published" {% if post and post.published %}checked{% endif %}>
            <label for="published">Published</label>
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="comments_enabled" name="comments_enabled" {% if not post or post.comments_enabled %}checked{% endif %}>
            <label for="comments_enabled">Enable Comments</label>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{% if post %}Update{% else %}Create{% endif %} Post</button>
            <a href="{{ url_for('admin.posts') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Styles for content image upload -->
<style>
    .content-image-upload {
        margin-bottom: 20px;
    }
    
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 5px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover, .upload-area.dragover {
        border-color: #3498db;
        background-color: #f0f8ff;
    }
    
    .upload-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    
    .image-item {
        position: relative;
        width: 150px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        background: white;
    }
    
    .image-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 3px;
        display: block;
    }
    
    .image-item .image-name {
        font-size: 12px;
        margin-top: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .image-item .image-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
    }
    
    .image-item .image-actions button {
        border: none;
        background: #f0f0f0;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .image-item .image-actions button.insert-btn {
        background: #3498db;
        color: white;
    }
    
    .image-item .image-actions button.delete-btn {
        background: #e74c3c;
        color: white;
    }
    
    .image-item .image-actions button:hover {
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Auto-generate slug from title
    document.addEventListener('DOMContentLoaded', function() {
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');
        
        if (titleInput && slugInput) {
            titleInput.addEventListener('blur', function() {
                if (slugInput.value === '' && titleInput.value !== '') {
                    // Simple slug generation
                    slugInput.value = titleInput.value
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim();
                }
            });
        }
        
        // Content image upload functionality
        setupContentImageUpload();
    });
    
    function setupContentImageUpload() {
        const dropzone = document.getElementById('content-image-dropzone');
        const fileInput = document.getElementById('content-image-input');
        const preview = document.getElementById('content-image-preview');
        const contentTextarea = document.getElementById('content');
        
        // Click to upload
        dropzone.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Drag and drop functionality
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                uploadContentImage(e.dataTransfer.files[0]);
            }
        });
        
        // File input change
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                uploadContentImage(fileInput.files[0]);
                fileInput.value = ''; // Reset for future uploads
            }
        });
        
        // Upload function
        function uploadContentImage(file) {
            // Check if file is an image
            if (!file.type.match('image.*')) {
                alert('Please upload an image file');
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading indicator
            const loadingItem = document.createElement('div');
            loadingItem.className = 'image-item';
            loadingItem.innerHTML = `
                <div style="padding: 40px 0; text-align: center;">
                    <p>Uploading...</p>
                </div>
            `;
            preview.appendChild(loadingItem);
            
            // Upload the image
            fetch('/admin/upload-content-image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading indicator
                preview.removeChild(loadingItem);
                
                if (data.success) {
                    // Create image preview item
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.innerHTML = `
                        <img src="${data.relative_url}" alt="${file.name}">
                        <div class="image-name">${file.name}</div>
                        <div class="image-actions">
                            <button type="button" class="insert-btn">Insert</button>
                            <button type="button" class="delete-btn">Delete</button>
                        </div>
                    `;
                    
                    // Store image data
                    imageItem.dataset.url = data.url;
                    imageItem.dataset.relativeUrl = data.relative_url;
                    imageItem.dataset.filename = data.filename;
                    
                    // Add to preview
                    preview.appendChild(imageItem);
                    
                    // Insert button click
                    const insertBtn = imageItem.querySelector('.insert-btn');
                    insertBtn.addEventListener('click', () => {
                        insertImageAtCursor(data.url, data.filename);
                    });
                    
                    // Delete button click
                    const deleteBtn = imageItem.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', () => {
                        preview.removeChild(imageItem);
                    });
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Remove loading indicator
                preview.removeChild(loadingItem);
                console.error('Error uploading image:', error);
                alert('Upload failed. Please try again.');
            });
        }
        
        // Insert image at cursor position
        function insertImageAtCursor(imageUrl, filename) {
            if (!contentTextarea) return;
            
            // Determine if we're in HTML or Markdown mode
            // For this implementation, we'll check if the content contains HTML tags
            const isHtmlMode = /<[a-z][\s\S]*>/i.test(contentTextarea.value);
            
            let imageCode;
            if (isHtmlMode) {
                // HTML format
                imageCode = `<img src="${imageUrl}" alt="${filename}" class="content-image">`;
            } else {
                // Markdown format
                imageCode = `![${filename}](${imageUrl})`;
            }
            
            // Get cursor position
            const startPos = contentTextarea.selectionStart;
            const endPos = contentTextarea.selectionEnd;
            
            // Insert image code at cursor
            contentTextarea.value = 
                contentTextarea.value.substring(0, startPos) + 
                imageCode + 
                contentTextarea.value.substring(endPos);
            
            // Set cursor position after inserted code
            contentTextarea.selectionStart = startPos + imageCode.length;
            contentTextarea.selectionEnd = startPos + imageCode.length;
            
            // Focus back on textarea
            contentTextarea.focus();
        }
    }
</script>
{% endblock %}
