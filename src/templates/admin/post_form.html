{% extends "admin/base_layout.html" %}

{% block title %}{% if post %}Edit Post{% else %}New Post{% endif %} - Dev Legal{% endblock %}

{% block header_title %}{% if post %}Edit Post{% else %}New Post{% endif %}{% endblock %}

{% block content %}
<div class="admin-content">
    <form method="POST" enctype="multipart/form-data" class="post-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="{{ post.title if post else '' }}" required>
        </div>
        
        <div class="form-group">
            <label for="slug">Slug</label>
            <input type="text" id="slug" name="slug" value="{{ post.slug if post else '' }}">
            <small>Leave empty to auto-generate from title</small>
        </div>
        
        <div class="form-group">
            <label for="post_date">Publication Date</label>
            <input type="datetime-local" id="post_date" name="post_date" value="{{ post.created_at.strftime('%Y-%m-%dT%H:%M') if post and post.created_at else '' }}">
            <small>Optional. If not specified, current date and time will be used.</small>
        </div>
        
        <div class="form-group">
            <label for="excerpt">Excerpt</label>
            <textarea id="excerpt" name="excerpt" rows="3">{{ post.excerpt if post else '' }}</textarea>
        </div>
        
        <div class="form-group format-toggle">
            <label>Content Format:</label>
            <div class="toggle-container">
                <input type="radio" id="format_html" name="content_format" value="html" {% if not post or not post.content_format or post.content_format == 'html' %}checked{% endif %}>
                <label for="format_html">HTML</label>
                
                <input type="radio" id="format_markdown" name="content_format" value="markdown" {% if post and post.content_format == 'markdown' %}checked{% endif %}>
                <label for="format_markdown">Markdown</label>
            </div>
            <small class="format-hint html-hint {% if post and post.content_format == 'markdown' %}hidden{% endif %}">HTML markup is allowed</small>
            <small class="format-hint markdown-hint {% if not post or not post.content_format or post.content_format == 'html' %}hidden{% endif %}">Markdown formatting will be converted to HTML when displayed</small>
        </div>
        
        <div class="form-group">
            <label for="content">Content</label>
            <textarea id="content" name="content" rows="15">{{ post.content if post else '' }}</textarea>
        </div>
        
        <!-- Content Image Upload Section -->
        <div class="form-group">
            <label>Content Image</label>
            <div class="content-image-upload">
                <div class="upload-container">
                    <input type="file" id="content_image_file" accept="image/*">
                    <button type="button" id="insert_content_image" class="btn btn-secondary">Insert Image at Cursor</button>
                </div>
                <div id="content_image_preview" class="image-preview">
                    <!-- Preview will appear here -->
                </div>
                <small>Upload an image to insert into your content. Supported formats: JPG, PNG, GIF, WebP</small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="category_id">Category</label>
            <select id="category_id" name="category_id" required>
                <option value="">Select Category</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if post and post.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Tags</label>
            <div class="tag-checkboxes">
                {% for tag in tags %}
                <div class="tag-checkbox">
                    <input type="checkbox" id="tag-{{ tag.id }}" name="tags" value="{{ tag.id }}" {% if post and tag in post.tags %}checked{% endif %}>
                    <label for="tag-{{ tag.id }}">{{ tag.name }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="form-group">
            <label for="featured_image_url">Featured Image URL</label>
            <input type="text" id="featured_image_url" name="featured_image_url" value="{{ post.featured_image if post else '' }}">
            <small>Enter a URL or upload an image below</small>
        </div>
        
        <div class="form-group">
            <label for="featured_image_file">Upload Featured Image</label>
            <input type="file" id="featured_image_file" name="featured_image_file" accept="image/*">
            <small>Supported formats: JPG, PNG, GIF, WebP</small>
            {% if post and post.featured_image %}
            <div class="current-image">
                <p>Current image:</p>
                <img src="{{ url_for('static', filename=post.featured_image) }}" alt="Featured image" style="max-width: 200px; max-height: 200px;">
            </div>
            {% endif %}
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="published" name="published" {% if post and post.published %}checked{% endif %}>
            <label for="published">Published</label>
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="comments_enabled" name="comments_enabled" {% if not post or post.comments_enabled %}checked{% endif %}>
            <label for="comments_enabled">Enable Comments</label>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{% if post %}Update{% else %}Create{% endif %} Post</button>
            <a href="{{ url_for('admin.posts') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Styles for content image upload and format toggle -->
<style>
    .format-toggle {
        margin-bottom: 10px;
    }
    
    .toggle-container {
        display: flex;
        gap: 20px;
        margin-bottom: 5px;
    }
    
    .format-hint {
        display: block;
        font-size: 0.8em;
        color: #666;
    }
    
    .hidden {
        display: none;
    }
    
    .content-image-upload {
        margin-bottom: 20px;
    }
    
    .upload-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .image-preview {
        margin-top: 10px;
        max-width: 300px;
    }
    
    .image-preview img {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Auto-generate slug from title and setup other functionality immediately
    document.addEventListener('DOMContentLoaded', function() {
        setupSlugGeneration();
        setupFormatToggle();
        setupContentImageUpload();
    });
    
    function setupSlugGeneration() {
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');
        
        if (titleInput && slugInput) {
            titleInput.addEventListener('blur', function() {
                if (slugInput.value === '' && titleInput.value !== '') {
                    // Simple slug generation
                    slugInput.value = titleInput.value
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim();
                }
            });
        }
    }
    
    function setupFormatToggle() {
        const htmlRadio = document.getElementById('format_html');
        const markdownRadio = document.getElementById('format_markdown');
        const htmlHint = document.querySelector('.html-hint');
        const markdownHint = document.querySelector('.markdown-hint');
        
        if (htmlRadio && markdownRadio) {
            htmlRadio.addEventListener('change', function() {
                if (this.checked) {
                    htmlHint.classList.remove('hidden');
                    markdownHint.classList.add('hidden');
                }
            });
            
            markdownRadio.addEventListener('change', function() {
                if (this.checked) {
                    markdownHint.classList.remove('hidden');
                    htmlHint.classList.add('hidden');
                }
            });
        }
    }
    
    function setupContentImageUpload() {
        console.log("Setting up content image upload...");
        
        // Get DOM elements
        const contentImageInput = document.getElementById('content_image_file');
        const insertButton = document.getElementById('insert_content_image');
        const previewContainer = document.getElementById('content_image_preview');
        const contentTextarea = document.getElementById('content');
        const htmlRadio = document.getElementById('format_html');
        const markdownRadio = document.getElementById('format_markdown');
        
        // Log elements to verify they're found
        console.log("Content image input:", contentImageInput);
        console.log("Insert button:", insertButton);
        console.log("Preview container:", previewContainer);
        console.log("Content textarea:", contentTextarea);
        
        // Variables to store uploaded image info
        let uploadedImageUrl = '';
        let uploadedImageFilename = '';
        
        // Initially disable the insert button until an image is uploaded
        if (insertButton) {
            insertButton.disabled = true;
        }
        
        // Handle file selection
        if (contentImageInput) {
            contentImageInput.addEventListener('change', function() {
                console.log("File input changed");
                
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    console.log("Selected file:", file.name);
                    
                    // Create a FormData object
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // Clear previous preview
                    previewContainer.innerHTML = '<p>Uploading...</p>';
                    
                    // Ensure insert button is disabled during upload
                    if (insertButton) {
                        insertButton.disabled = true;
                    }
                    
                    console.log("Uploading file...");
                    
                    // Use the existing upload endpoint (same as featured image)
                    fetch('/admin/upload-image', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        console.log("Upload response received");
                        return response.json();
                    })
                    .then(data => {
                        console.log("Upload response data:", data);
                        
                        if (data.success) {
                            // Store the uploaded image URL
                            uploadedImageUrl = data.url;
                            uploadedImageFilename = file.name;
                            
                            console.log("Image uploaded successfully:", uploadedImageUrl);
                            
                            // Show preview
                            previewContainer.innerHTML = `
                                <img src="${uploadedImageUrl}" alt="${file.name}">
                                <p>${file.name}</p>
                            `;
                            
                            // Enable insert button
                            if (insertButton) {
                                insertButton.disabled = false;
                                console.log("Insert button enabled");
                            }
                        } else {
                            console.error("Upload failed:", data.error || "Unknown error");
                            previewContainer.innerHTML = '<p>Upload failed. Please try again.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error uploading image:', error);
                        previewContainer.innerHTML = '<p>Upload failed. Please try again.</p>';
                    });
                }
            });
        }
        
        // Handle insert button click
        if (insertButton) {
            console.log("Adding click event listener to insert button");
            
            insertButton.addEventListener('click', function(e) {
                console.log("Insert button clicked");
                e.preventDefault(); // Prevent form submission
                
                if (!uploadedImageUrl || !contentTextarea) {
                    console.log("Missing uploadedImageUrl or contentTextarea");
                    return;
                }
                
                // Determine if we're in HTML or Markdown mode based on the radio buttons
                const isHtmlMode = htmlRadio.checked;
                console.log("HTML mode:", isHtmlMode);
                
                let imageCode;
                if (isHtmlMode) {
                    // HTML format
                    imageCode = `<img src="${uploadedImageUrl}" alt="${uploadedImageFilename}" class="content-image">`;
                } else {
                    // Markdown format
                    imageCode = `![${uploadedImageFilename}](${uploadedImageUrl})`;
                }
                
                console.log("Image code to insert:", imageCode);
                
                // Get cursor position
                const startPos = contentTextarea.selectionStart;
                const endPos = contentTextarea.selectionEnd;
                
                // Insert image code at cursor
                contentTextarea.value = 
                    contentTextarea.value.substring(0, startPos) + 
                    imageCode + 
                    contentTextarea.value.substring(endPos);
                
                // Set cursor position after inserted code
                contentTextarea.selectionStart = startPos + imageCode.length;
                contentTextarea.selectionEnd = startPos + imageCode.length;
                
                // Focus back on textarea
                contentTextarea.focus();
                
                console.log("Image inserted at cursor position");
                
                // Reset the file input for next upload
                contentImageInput.value = '';
                
                // Disable the insert button until next upload
                insertButton.disabled = true;
            });
        }
    }
    
    // Call setup immediately in case DOMContentLoaded already fired
    if (document.readyState === 'loading') {
        console.log("Document still loading, waiting for DOMContentLoaded");
    } else {
        console.log("Document already loaded, running setup immediately");
        setupSlugGeneration();
        setupFormatToggle();
        setupContentImageUpload();
    }
</script>
{% endblock %}
